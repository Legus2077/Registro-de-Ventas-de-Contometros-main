<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Resumen Gerencial</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-dark">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand">Gestor de Ventas</span>
        <div class="d-flex">
            <a href="{{ url_for('registrar_venta') }}" class="btn btn-primary me-2">➕ Registrar Venta</a> 
            
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light me-2 active">Dashboard</a>
            <a href="{{ url_for('ranking_clientes') }}" class="btn btn-outline-light me-2">Ranking</a>
            <a href="{{ url_for('ver_ventas') }}" class="btn btn-outline-light me-2">Ver Ventas</a>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-light" onclick="return confirm('¿Seguro que deseas cerrar sesión?');">Cerrar sesión</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2 class="mb-4">Bienvenido, {{ usuario }}</h2>

    {% if mensaje %}
        <div class="alert alert-success">{{ mensaje }}</div>
    {% endif %}
    
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Ganancia Total Acumulada</h5>
                    <p class="card-text fs-1">S/ {{ "%.2f"|format(total_ganancia) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total de Registros de Venta</h5>
                    <p class="card-text fs-1">{{ total_ventas }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Ganancia Mensual Histórica</div>
        <div class="card-body">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

</div>

<script>
    
    const rawData = {{ ganancia_mensual | tojson | safe }}; // No hay problema con este error
    const labels = rawData.map(item => `${item[1]}/${item[0]}`);
    const data = rawData.map(item => item[2]); 

    const ctx = document.getElementById('monthlyChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ganancia Mensual (S/)',
                data: data,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

</body>
</html>